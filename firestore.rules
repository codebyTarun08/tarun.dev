rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * CORE PHILOSOPHY:
     * This ruleset implements a Role-Based Access Control (RBAC) model specifically designed for a single-owner portfolio
     * application. Security is decoupled from data hierarchy by utilizing a dedicated 'app_roles' collection to
     * identify the portfolio owner.
     *
     * DATA STRUCTURE:
     * - /app_roles/portfolioOwners/{uid}: A system-level collection where the existence of a document grants administrative rights.
     * - /skills: Publicly viewable skills, filtered by an 'isDisplayed' flag.
     * - /projects: Publicly viewable projects, filtered by the presence of a 'liveUrl'.
     * - /contactMessages: A collection for public inquiries, accessible only by the owner.
     *
     * KEY SECURITY DECISIONS:
     * - Authorization Independence: We use an `exists()` check against the `app_roles` collection to determine ownership,
     *   avoiding the need for complex parent-child relationships or expensive recursive lookups.
     * - Public vs. Private: While 'skills' and 'projects' are top-level for performance, read access is strictly
     *   governed by internal document state (e.g., 'isDisplayed') to ensure drafts or internal data aren't leaked.
     * - Prototyping Flexibility: Rules enforce relational integrity (matching IDs) and ownership but do not
     *   restrict the specific schema of content fields, allowing for rapid front-end iteration.
     */

    // --- Helper Functions ---

    /**
     * @description Checks if the request is made by an authenticated user.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Determines if the authenticated user is the registered portfolio owner.
     * Uses the Authorization Independence pattern via a system-level role check.
     */
    function isPortfolioOwner() {
      return isSignedIn() && exists(/databases/$(database)/documents/app_roles/portfolioOwners/$(request.auth.uid));
    }

    /**
     * @description Combines the owner check with a resource existence check for safe updates and deletes.
     */
    function isExistingPortfolioOwner() {
      return isPortfolioOwner() && resource != null;
    }

    // --- Collection Rules ---

    /**
     * @description System collection defining portfolio ownership.
     * @path /app_roles/portfolioOwners/{ownerUid}
     * @allow (get) If the user is checking their own owner status.
     * @deny (list, write) Prevents listing owners or self-promotion to owner via the client.
     * @principle Verified Identity / Role-Based Access Control.
     */
    match /app_roles/portfolioOwners/{ownerUid} {
      allow get: if isSignedIn() && request.auth.uid == ownerUid;
      allow list: if false;
      allow create, update, delete: if false;
    }

    /**
     * @description Manages technical and soft skills for the portfolio.
     * @path /skills/{skillId}
     * @allow (get, list) If the skill is marked for display or the requester is the owner.
     * @allow (create, update, delete) Only by the portfolio owner.
     * @principle Public Read with Owner-Only Writes / Relational Integrity.
     */
    match /skills/{skillId} {
      allow get, list: if resource.data.isDisplayed == true || isPortfolioOwner();
      allow create: if isPortfolioOwner() && request.resource.data.id == skillId;
      allow update: if isExistingPortfolioOwner() && request.resource.data.id == resource.data.id;
      allow delete: if isExistingPortfolioOwner();
    }

    /**
     * @description Manages portfolio projects and their display status.
     * @path /projects/{projectId}
     * @allow (get, list) If the project has a live URL (is published) or the requester is the owner.
     * @allow (create, update, delete) Only by the portfolio owner.
     * @principle Public Read with Owner-Only Writes / Relational Integrity.
     */
    match /projects/{projectId} {
      allow get, list: if (resource.data.liveUrl != null && resource.data.liveUrl != "") || isPortfolioOwner();
      allow create: if isPortfolioOwner() && request.resource.data.id == projectId;
      allow update: if isExistingPortfolioOwner() && request.resource.data.id == resource.data.id;
      allow delete: if isExistingPortfolioOwner();
    }

    /**
     * @description Handles contact form submissions from visitors.
     * @path /contactMessages/{messageId}
     * @allow (create) Publicly accessible for anyone to send a message.
     * @allow (get, list, update, delete) Restricted entirely to the portfolio owner.
     * @principle Public Write / Restricted Read-Management.
     */
    match /contactMessages/{messageId} {
      allow create: if request.resource.data.id == messageId;
      allow get, list: if isPortfolioOwner();
      allow update: if isExistingPortfolioOwner() && request.resource.data.id == resource.data.id;
      allow delete: if isExistingPortfolioOwner();
    }
  }
}